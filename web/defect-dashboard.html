<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defect Dashboard</title>
</head>
<body>
    
    <h3>Defects</h3>

    <table>
        <thead><tr><th>ID</th><th>desc</th><th>Assigned To</th><th>status</th><th>steps</th><th>Details</th></tr></thead>
        <tbody id="defectTableBody">
       
        </tbody>
    </table>

    <dialog id="stepsModal">
        <p id="stepsInfo">This cannot be that easy</p>
        <button data-action="closeModal">Close</button>
    </dialog>


</body>
<script>
    

    let defects = [];
    getDefects();

    const stepsModal = document.getElementById("stepsModal");
    const stepsInfo = document.getElementById("stepsInfo");
    const defectTableBody = document.getElementById("defectTableBody");

    document.addEventListener("click", async function(event){

        const action = event.target.dataset.action;

        if(action === "showSteps"){
            const defect = defects.find(d => d.defectId == event.target.dataset.defectid)
            stepsInfo.innerText = defect.stepsToReproduce;
            stepsModal.showModal();
        }

        if(action === "closeModal"){
            stepsModal.close();
        }
    });

    async function getDefects(){
        const response = await fetch(`${window.location.origin}/defects`);
        defects = await response.json(); 
        renderTable()
    }

    function renderTable(){

        defectTableBody.innerHTML = defects.map(d =>`
            <tr>
                <td>${d.defectId}</td>
                <td>${d.desc}</td>
                <td>${d.assignedTo}</td>
                <td>${d.status}</td>
                <td><button data-action="showSteps" data-defectid="${d.defectId}">Steps</button></td>
                <td><a href="defect-editor.html?id=${d.defectId}">modify</a></td>
            </tr>
        `).join("");
    }

</script>
</html>